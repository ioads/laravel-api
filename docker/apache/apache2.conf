# Server root directory
ServerRoot "/etc/apache2"

# Server name
ServerName 0.0.0.0

# Hide Apache version information to enhance security
ServerTokens Prod
ServerSignature Off

# Timeout settings for client connections
Timeout 60

# KeepAlive settings to allow persistent connections
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# MPM (Multi-Processing Module) configuration optimized for high load
<IfModule mpm_event_module>
    StartServers 2
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadLimit 64
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 1000
</IfModule>

# Virtual host configuration
<VirtualHost *:8080>
    DocumentRoot /var/www/public

    # Directory security settings
    <Directory /var/www/public>
        AllowOverride All
        Require all granted
        
        # Disable directory listing
        Options -Indexes

        # Block access to hidden files and sensitive extensions
        <FilesMatch "^\.|(\.env|\.git|\.htaccess|\.ini|\.log|\.sh|\.bak|\.sql)$">
            Require all denied
        </FilesMatch>
    </Directory>

    # Logging settings
    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log combined

    # Pass the Authorization header to the application
    SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
</VirtualHost>

# Enable GZIP compression for improved performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

# Enable security headers
<IfModule mod_headers.c>
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "DENY"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "no-referrer"
</IfModule>

# Configure PHP-FPM with FastCGI using Unix socket
<IfModule mod_proxy_fcgi.c>
    <FilesMatch "\.php$">
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://localhost/"
    </FilesMatch>
</IfModule>

# Include module configuration files
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf